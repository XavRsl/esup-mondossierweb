<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Calendrier">

<resultMap id="resultCalendrier" class="org.esupportail.mondossierweb.domain.beans.Examen">
<result property="date" column="DATDEB"/>
<result property="heure" column="HEURE"/>
<result property="duree" column="DUREE"/>
<result property="salle" column="SALLE"/>
<result property="place" column="PLACE"/>
<result property="batiment" column="BATIMENT"/>
<result property="epreuve" column="EPREUVE"/>
<result property="codCin" column="CIN"/>
</resultMap>


<select id="getExamens" resultMap="resultCalendrier">
SELECT DISTINCT to_char(PESA.DAT_DEB_PES,'DD/MM/YYYY') DATDEB, 
DECODE(SUBSTR(TO_CHAR(PESA.DHH_DEB_PES),1,1),'1',
TO_CHAR(PESA.DHH_DEB_PES),'0'||TO_CHAR(PESA.DHH_DEB_PES)) ||':'||
DECODE(TO_CHAR(PESA.DMM_DEB_PES),'0','00',TO_CHAR(PESA.DMM_DEB_PES)) HEURE,
PESA.DUR_EXA_EPR_PES || ' min.' DUREE,
PESA.COD_SAL SALLE,
NVL(TO_CHAR(PI.NUM_PLC_AFF_PSI),' ') PLACE,
BAT.LIB_BAT BATIMENT, E.LIB_EPR EPREUVE,
'' CIN
FROM APOGEE.PRD_EPR_SAL_ANU PESA,APOGEE.EPREUVE E,APOGEE.PES_IND PI,APOGEE.BATIMENT BAT,
APOGEE.SALLE SAL,APOGEE.PERIODE_EXA PEX 
WHERE  PI.COD_IND=#value#
AND PI.COD_PES=PESA.COD_PES 
AND  PESA.COD_EPR=E.COD_EPR AND  PESA.COD_PXA = PEX.COD_PXA 
AND  PEX.LIB_PXA LIKE '@%' AND  SAL.COD_SAL = PESA.COD_SAL 
AND  BAT.COD_BAT = SAL.COD_BAT 
ORDER BY DATDEB,2
</select>

<select id="getExamensEtape" resultMap="resultCalendrier">
SELECT DISTINCT to_char(PESA.DAT_DEB_PES,'DD/MM/YYYY') DATDEB,
DECODE(SUBSTR(TO_CHAR(PESA.DHH_DEB_PES),1,1),'1',
TO_CHAR(PESA.DHH_DEB_PES),'0'||TO_CHAR(PESA.DHH_DEB_PES)) ||':'||
DECODE(TO_CHAR(PESA.DMM_DEB_PES),'0','00',TO_CHAR(PESA.DMM_DEB_PES)) HEURE,
DECODE(PESA.DUR_EXA_EPR_PES, '0', '',to_char(to_date(PESA.DUR_EXA_EPR_PES*60,'SSSSS'),'HH24:MI')) DUREE,
SAL.LIB_SAL SALLE,
NVL(TO_CHAR(PI.NUM_PLC_AFF_PSI),' ') PLACE,
BAT.LIB_BAT BATIMENT, E.LIB_EPR EPREUVE,
PEX.COD_CIN CIN
FROM APOGEE.PRD_EPR_SAL_ANU PESA,APOGEE.EPREUVE E,APOGEE.PES_IND PI,APOGEE.BATIMENT BAT,
APOGEE.SALLE SAL,APOGEE.PERIODE_EXA PEX,
APOGEE.EPR_CLN,
DEVAPO.REN1_AFF_EPR,
APOGEE.IND_CONTRAT_ELP ICE,
APOGEE.EPR_SANCTIONNE_ELP ESE
WHERE  PI.COD_IND = #chaine1#
AND PI.COD_PES=PESA.COD_PES
AND  PESA.COD_EPR=E.COD_EPR AND  PESA.COD_PXA = PEX.COD_PXA
AND  SAL.COD_SAL = PESA.COD_SAL
AND  BAT.COD_BAT = SAL.COD_BAT
AND  EPR_CLN.COD_EPR = PESA.COD_EPR
AND  REN1_AFF_EPR.COD_CLN = EPR_CLN.COD_CLN
AND  sysdate between REN1_AFF_EPR.DAT_DEB_AFF and REN1_AFF_EPR.DAT_FIN_AFF
AND  REN1_AFF_EPR.COD_PXA = PEX.COD_PXA
AND  REN1_AFF_EPR.COD_ANU = PESA.COD_ANU
AND  REN1_AFF_EPR.COD_ETP = ICE.COD_ETP
AND  REN1_AFF_EPR.COD_VRS_VET = ICE.COD_VRS_VET
AND  REN1_AFF_EPR.COD_EPR = PESA.COD_EPR
AND  REN1_AFF_EPR.COD_PES = PESA.COD_PES
AND ICE.COD_IND = PI.COD_IND
AND ICE.COD_ANU = PESA.COD_ANU
AND ICE.COD_ETP = #chaine2#
AND ICE.COD_VRS_VET = #chaine3#
AND ICE.COD_ELP = ESE.COD_ELP
AND ESE.COD_EPR = PESA.COD_EPR
ORDER BY TO_DATE(DATDEB,'DD/MM/YYYY'),HEURE
</select>

<select id="getPageInfos" resultClass="java.lang.String">
SELECT INFO
FROM REN1_CALEND_EPR_INFO
WHERE COD_CIN = #value#
</select>


</sqlMap>

	